---
layout:     post
title:      "用开源产品撸个监控系统（三）——非完美实现报警系统"
date:       2016-11-18 08:00:00
author:     "DongYeo"
header-img: "img/post-bg-03.jpg"
tags: ["监控系统","日志采集"]
---

## 前言

线上业务越来越繁重，运维体系中看上去最不重要，但实际上是最重要的一环便是监控。快速统计线上业务数据、高效展示监控数据、及时针对业务异常做出针对性的报警、存储监控数据用于大数据计算对在线数据进行预测和异常检测，这些都是监控系统在运维体系中发挥的作用。

根据监控系统的功能，不难分析出，监控系统的极大核心功能分别是：采集、存储、展示、计算、报警。

![monitor-func]({{ site.baseurl }}/img/monitor-func.jpg)

本系列博（bi）客（ji）将记录我使用如下开源工具，搭建一个小巧的监控系统，进而剖析监控系统是如何运作的：

- Logster
- graphite
- storm

## 报警模型

当我们通过前两篇文章的工具将相关业务的指标采集并存储以后，我们需要根据实际的业务特性和关键程度来针对其关键指标配置响应的报警。

例如：某网站的访问PV（200状态码统计）是一个核心的业务指标，在业务正常的情况下，这一指标的曲线是非常的平滑的，当这一指标突然出现下跌，那么，和可能这一业务相关的系统很有可能出现了异常，需要告警来提醒相关人员上线处理异常。

上面那个例子中，我们可以抽象出一个报警规则，200状态码1分钟求和环比下跌XX%，业务出现异常，这个XX%取决于业务正常波动和实际异常的跌幅。那么通常我们有哪些报警的数据计算方式？

报警指标|计算模型|触发类型|特点
---|---|---|---
当前值|阈值比较|边沿触发|适合针对一些稳定的业务指标，例如成功率低于XX%，失败数大于XX
当前值环比|比例阈值比较|边沿触发|适合业务平稳，波动性小，具有一定周期性的业务指标
当前值同比|比例阈值比较|边沿触发|适合周期性强的指标，例如昨日同比、上周同比等
N时间单位聚合|阈值比较|边沿触发|适合指标小，波动大的脉冲式的指标，用于兜底业务，防止N周期内业务量过小的异常**<b style="color:red">以此衍生的还有N时间单位聚合同比</b>**
N时间单位聚合环比|比例阈值比较|边沿触发|适合单位时间波动大，单整体具有一定周期和稳定趋势的业务指标，起到滤波的作用
N时间单位持续|阈值比较|电平触发|适合脉冲、抖动打的业务指标监控，例如持续跌零，持续过高等
周期分解残差|残差的异常检测|算法检测边沿触发|适合周期性极强的业务指标，通过类似于STL的季节分解，将时间序列分解为趋势+周期+残差，最后，对残差使用MWA之类的异常检测算法进行检测


## 技术实现

有了业务指标，有了报警模型，我们就可通过一定的技术手段实现报警逻辑。
报警需要具有非常强的实时性，需要在很短的时间将指标根据报警模型进行计算，并将异常很快的告诉业务方。

开源世界里有很多的实时计算引擎，例如Spark、Storm等，本次我们就使用Storm来作为我们的实时计算引擎，来对我们业务PV进行当前值的监控。
![monitor-func]({{ site.baseurl }}/img/storm-logo.png)
先介绍下整个Storm报警的模型的topology:
![monitor-func]({{ site.baseurl }}/img/topology.png)
